name: GenAssist-GitHub-Backend_$(Date:yyyyMMdd)$(Rev:.r)

pool:
  name: Ritech-AI-TR1

trigger:
  branches:
    include:
      - development
  paths:
    include:
      - backend/**

pr:
  branches:
    include:
      - development
  paths:
    include:
      - backend/**

steps:
  - checkout: self
    clean: true
    fetchTags: true

  - task: UseDotNet@2
    displayName: 'Use .NET Core sdk 8.X'
    inputs:
      version: 8.x

  - task: gittools.gittools.setup-gitversion-task.gitversion/setup@3
    displayName: 'gitversion-setup'
    inputs:
      versionSpec: 5.x

  - script: |
      echo "stopping existing containers of cicd"
      touch .env
      docker compose -f docker-compose.cicd.yml -p genassist_cicd down --rmi all --volumes --remove-orphans
    workingDirectory: backend
    displayName: 'Stop Test Containers - Before Start'

  - task: DownloadSecureFile@1
    name: cicdenv
    displayName: 'Download .env for CICD'
    inputs:
      secureFile: env.cicd

  - script: |
      set -euo pipefail

      BACKEND_DIR="$(System.DefaultWorkingDirectory)/backend"
      ENV_FILE="$BACKEND_DIR/.env"

      cp "$(cicdenv.secureFilePath)" "$ENV_FILE"
      cd "$BACKEND_DIR"

      branch="$(Build.SourceBranch)"
      branchNo="${branch#refs/heads/}"

      echo -e "\nAPI_VERSION=${branchNo}-$(Build.BuildNumber)" >> "$ENV_FILE"

      esc_sed() { printf '%s' "$1" | sed -e 's/[\/&]/\\&/g'; }

      OAIKEY_ESC="$(esc_sed "$OAIKEY")"
      HFTOKEN_ESC="$(esc_sed "$HFTOKEN")"
      FERNET_KEY_ESC="$(esc_sed "$FERNET_KEY")"
      S3_ACCESS_KEY_ID_ESC="$(esc_sed "$S3_ACCESS_KEY_ID")"
      S3_SECRET_ACCESS_KEY_ESC="$(esc_sed "$S3_SECRET_ACCESS_KEY")"

      sed -i "s/OPENAI_API_KEY_VALUE/${OAIKEY_ESC}/g" "$ENV_FILE"
      sed -i "s/HUGGINGFACE_TOKEN_VALUE/${HFTOKEN_ESC}/g" "$ENV_FILE"
      sed -i "s/FERNET_KEY_VALUE/${FERNET_KEY_ESC}/g" "$ENV_FILE"
      sed -i "s/AWS_ACCESS_KEY_ID_VALUE/${S3_ACCESS_KEY_ID_ESC}/g" "$ENV_FILE"
      sed -i "s/AWS_SECRET_ACCESS_KEY_VALUE/${S3_SECRET_ACCESS_KEY_ESC}/g" "$ENV_FILE"

      sed -i 's/DEBUG=false/DEBUG=true/g' "$ENV_FILE"

      echo -e "\nCREATE_DB=true" >> "$ENV_FILE"
      sed -i 's/DB_HOST=db/DB_HOST=genassist_db/g' "$ENV_FILE"

      echo -e "\nCHROMA_HOST=chroma" >> "$ENV_FILE"
      echo -e "\nCHROMA_PORT=8000" >> "$ENV_FILE"

      echo "starting fresh db"
      docker compose -f docker-compose.cicd.yml -p genassist_cicd up --force-recreate -d db

      echo "starting app and whisper"
      docker compose -f docker-compose.cicd.yml -p genassist_cicd up --build --force-recreate -d app whisper
    workingDirectory: backend
    displayName: 'Build and Start App + Whisper'
    env:
      OAIKEY: $(OAIKEY)
      HFTOKEN: $(HFTOKEN)
      FERNET_KEY: $(FERNET_KEY)
      S3_ACCESS_KEY_ID: $(S3_ACCESS_KEY_ID)
      S3_SECRET_ACCESS_KEY: $(S3_SECRET_ACCESS_KEY)

  - script: |
      set -euo pipefail
      OUT_DIR="$(System.DefaultWorkingDirectory)"

      echo "Upgrading pip tooling..."
      docker exec genassist-app-cicd python -m pip install -q -U pip setuptools wheel

      echo "üìä Playwright check..."

      echo "Installing test dependencies..."
      docker exec genassist-app-cicd python -m pip install -q \
        "pytest>=8.2,<9" \
        "pytest-asyncio>=0.26,<0.27" \
        pytest-cov pytest-azurepipelines coverage

        docker exec genassist-app-cicd sh -lc '
        python - << "PY"
        from playwright.sync_api import sync_playwright
        with sync_playwright() as p:
            b = p.chromium.launch(headless=True, args=["--no-sandbox","--disable-dev-shm-usage"])
            b.close()
        print("PLAYWRIGHT OK")
        PY
        '


      echo "üìä Running pytest (writing /src/pytest.log)..."
      TEST_RESULT=0
      if ! docker exec -w /src genassist-app-cicd sh -lc '
        set -e
        python -m pytest tests \
          -vvv \
          --cov=app --cov-branch \
          --cov-report xml:/src/coverage.xml \
          --cov-report html:/src/htmlcov \
          --junitxml=/src/test-results.xml \
          --no-coverage-upload \
          -s -o log_cli=true -o log_cli_level=DEBUG \
          2>&1 | tee /src/pytest.log
      '; then
        echo "‚ùå Tests failed (tail of pytest log):"
        docker exec genassist-app-cicd sh -lc 'tail -n 200 /src/pytest.log || true'

        echo "Diagnostics:"
        docker exec -w /src genassist-app-cicd python -m pytest -q --maxfail=1 || true
        docker exec -w /src genassist-app-cicd python -m pytest --help | head -n 80 || true
        docker exec -w /src genassist-app-cicd python -m pytest --help | grep -n "no-coverage-upload" || true
        docker exec -w /src genassist-app-cicd python -m pip show pytest pytest-cov pytest-azurepipelines || true

        TEST_RESULT=1
      fi

      echo "Listing /src outputs:"
      docker exec genassist-app-cicd ls -lah /src | sed -n '1,200p'

      if docker exec genassist-app-cicd test -f /src/test-results.xml; then
        docker cp genassist-app-cicd:/src/test-results.xml "$OUT_DIR/test-results.xml"
      else
        echo "‚ö†Ô∏è Missing /src/test-results.xml"
      fi

      if docker exec genassist-app-cicd test -f /src/coverage.xml; then
        docker cp genassist-app-cicd:/src/coverage.xml "$OUT_DIR/coverage.xml"
      else
        echo "‚ö†Ô∏è Missing /src/coverage.xml"
      fi

      if docker exec genassist-app-cicd test -d /src/htmlcov; then
        docker cp genassist-app-cicd:/src/htmlcov "$OUT_DIR/htmlcov"
      else
        echo "‚ö†Ô∏è Missing /src/htmlcov"
      fi

      # Optional: keep the pytest log as an artifact too
      if docker exec genassist-app-cicd test -f /src/pytest.log; then
        docker cp genassist-app-cicd:/src/pytest.log "$OUT_DIR/pytest.log"
      fi

      exit $TEST_RESULT

    displayName: 'Start Tests'
    timeoutInMinutes: 3

  - script: |
      docker compose -f docker-compose.cicd.yml -p genassist_cicd down --rmi all --volumes --remove-orphans
    workingDirectory: backend
    displayName: 'Stop Test Containers - After End'
    condition: always()

  - task: PublishTestResults@2
    displayName: 'Publish Test Results'
    inputs:
      testResultsFiles: '$(System.DefaultWorkingDirectory)/test-results.xml'
      testRunTitle: 'Backend Tests'
      failTaskOnFailedTests: true
    condition: succeededOrFailed()

  - task: PublishCodeCoverageResults@2
    displayName: 'Publish code coverage results'
    inputs:
      summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage.xml'
      pathToSources: '$(System.DefaultWorkingDirectory)/backend/app/'
    condition: succeededOrFailed()

  - task: PublishPipelineArtifact@1
    displayName: 'Publish Pipeline Artifact'
    inputs:
      targetPath: '$(System.DefaultWorkingDirectory)/backend'
      artifact: code
    condition: succeededOrFailed()